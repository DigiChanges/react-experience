{"version":3,"sources":["../../server/hot-reloader.ts"],"names":["renderScriptError","res","error","setHeader","code","message","statusCode","end","console","stack","addCorsSupport","req","isApiRoute","url","match","API_ROUTE","preflight","headers","origin","method","writeHead","matchNextPageBundleRequest","findEntryModule","issuer","erroredPages","compilation","options","enhanceName","name","failedPages","errors","entryModule","IS_BUNDLED_PAGE_REGEX","test","enhancedName","push","HotReloader","constructor","dir","config","pagesDir","buildId","previewProps","middlewares","webpackDevMiddleware","webpackHotMiddleware","initialized","stats","serverStats","serverPrevDocumentHash","prevChunkNames","onDemandEntries","send","action","args","publish","data","run","parsedUrl","handlePageBundleRequest","pathname","params","page","path","join","BLOCKED_PAGES","indexOf","ensurePage","finished","bundlePath","distDir","mod","require","amp","_","getCompilationErrors","length","fn","Promise","resolve","reject","err","clean","getWebpackConfig","pagePaths","all","pageExtensions","pages","filter","i","entrypoints","additionalClientEntrypoints","CLIENT_STATIC_FILES_RUNTIME_AMP","sep","NEXT_PROJECT_ROOT_DIST_CLIENT","CLIENT_STATIC_FILES_RUNTIME_REACT_REFRESH","dev","isServer","client","server","start","configs","multiCompiler","buildTools","prepareBuildTools","assignBuildTools","waitUntilValid","stop","middleware","close","reload","compiler","oldWebpackDevMiddleware","rootDirectory","compilers","hooks","done","tap","documentChunk","chunks","find","c","warn","hash","chunkNames","Set","map","addedPages","diff","removedPages","size","addedPage","ROUTE_NAME_REGEX","exec","replace","removedPage","ignored","webpackDevMiddlewareConfig","publicPath","noInfo","logLevel","watchOptions","writeToDisk","log","configOrigin","heartbeat","bind","normalizedPage","waitUntilReloaded","hasErrors","a","b","v","has"],"mappings":"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","sourcesContent":["import { getOverlayMiddleware } from '@next/react-dev-overlay/lib/middleware'\nimport { NextHandleFunction } from 'connect'\nimport { IncomingMessage, ServerResponse } from 'http'\nimport WebpackDevMiddleware from 'next/dist/compiled/webpack-dev-middleware'\nimport WebpackHotMiddleware from 'next/dist/compiled/webpack-hot-middleware'\nimport { join, normalize, relative as relativePath, sep } from 'path'\nimport { UrlObject } from 'url'\nimport webpack from 'webpack'\nimport { createEntrypoints, createPagesMapping } from '../build/entries'\nimport { watchCompilers } from '../build/output'\nimport getBaseWebpackConfig from '../build/webpack-config'\nimport { API_ROUTE, NEXT_PROJECT_ROOT_DIST_CLIENT } from '../lib/constants'\nimport { recursiveDelete } from '../lib/recursive-delete'\nimport {\n  BLOCKED_PAGES,\n  CLIENT_STATIC_FILES_RUNTIME_AMP,\n  CLIENT_STATIC_FILES_RUNTIME_REACT_REFRESH,\n  IS_BUNDLED_PAGE_REGEX,\n  ROUTE_NAME_REGEX,\n} from '../next-server/lib/constants'\nimport { __ApiPreviewProps } from '../next-server/server/api-utils'\nimport { route } from '../next-server/server/router'\nimport errorOverlayMiddleware from './lib/error-overlay-middleware'\nimport { findPageFile } from './lib/find-page-file'\nimport onDemandEntryHandler, { normalizePage } from './on-demand-entry-handler'\n\nexport async function renderScriptError(res: ServerResponse, error: Error) {\n  // Asks CDNs and others to not to cache the errored page\n  res.setHeader(\n    'Cache-Control',\n    'no-cache, no-store, max-age=0, must-revalidate'\n  )\n\n  if (\n    (error as any).code === 'ENOENT' ||\n    error.message === 'INVALID_BUILD_ID'\n  ) {\n    res.statusCode = 404\n    res.end('404 - Not Found')\n    return\n  }\n\n  console.error(error.stack)\n  res.statusCode = 500\n  res.end('500 - Internal Error')\n}\n\nfunction addCorsSupport(req: IncomingMessage, res: ServerResponse) {\n  const isApiRoute = req.url!.match(API_ROUTE)\n  // API routes handle their own CORS headers\n  if (isApiRoute) {\n    return { preflight: false }\n  }\n\n  if (!req.headers.origin) {\n    return { preflight: false }\n  }\n\n  res.setHeader('Access-Control-Allow-Origin', req.headers.origin)\n  res.setHeader('Access-Control-Allow-Methods', 'OPTIONS, GET')\n  // Based on https://github.com/primus/access-control/blob/4cf1bc0e54b086c91e6aa44fb14966fa5ef7549c/index.js#L158\n  if (req.headers['access-control-request-headers']) {\n    res.setHeader(\n      'Access-Control-Allow-Headers',\n      req.headers['access-control-request-headers'] as string\n    )\n  }\n\n  if (req.method === 'OPTIONS') {\n    res.writeHead(200)\n    res.end()\n    return { preflight: true }\n  }\n\n  return { preflight: false }\n}\n\nconst matchNextPageBundleRequest = route(\n  '/_next/static/:buildId/pages/:path*.js(\\\\.map|)'\n)\n\n// Recursively look up the issuer till it ends up at the root\nfunction findEntryModule(issuer: any): any {\n  if (issuer.issuer) {\n    return findEntryModule(issuer.issuer)\n  }\n\n  return issuer\n}\n\nfunction erroredPages(\n  compilation: webpack.compilation.Compilation,\n  options = { enhanceName: (name: string) => name }\n) {\n  const failedPages: { [page: string]: any[] } = {}\n  for (const error of compilation.errors) {\n    if (!error.origin) {\n      continue\n    }\n\n    const entryModule = findEntryModule(error.origin)\n    const { name } = entryModule\n    if (!name) {\n      continue\n    }\n\n    // Only pages have to be reloaded\n    if (!IS_BUNDLED_PAGE_REGEX.test(name)) {\n      continue\n    }\n\n    const enhancedName = options.enhanceName(name)\n\n    if (!failedPages[enhancedName]) {\n      failedPages[enhancedName] = []\n    }\n\n    failedPages[enhancedName].push(error)\n  }\n\n  return failedPages\n}\n\nexport default class HotReloader {\n  private dir: string\n  private buildId: string\n  private middlewares: any[]\n  private pagesDir: string\n  private webpackDevMiddleware: WebpackDevMiddleware.WebpackDevMiddleware | null\n  private webpackHotMiddleware:\n    | (NextHandleFunction & WebpackHotMiddleware.EventStream)\n    | null\n  private initialized: boolean\n  private config: any\n  private stats: any\n  private serverStats: any\n  private serverPrevDocumentHash: string | null\n  private prevChunkNames?: Set<any>\n  private onDemandEntries: any\n  private previewProps: __ApiPreviewProps\n\n  constructor(\n    dir: string,\n    {\n      config,\n      pagesDir,\n      buildId,\n      previewProps,\n    }: {\n      config: object\n      pagesDir: string\n      buildId: string\n      previewProps: __ApiPreviewProps\n    }\n  ) {\n    this.buildId = buildId\n    this.dir = dir\n    this.middlewares = []\n    this.pagesDir = pagesDir\n    this.webpackDevMiddleware = null\n    this.webpackHotMiddleware = null\n    this.initialized = false\n    this.stats = null\n    this.serverStats = null\n    this.serverPrevDocumentHash = null\n\n    this.config = config\n    this.previewProps = previewProps\n  }\n\n  async run(req: IncomingMessage, res: ServerResponse, parsedUrl: UrlObject) {\n    // Usually CORS support is not needed for the hot-reloader (this is dev only feature)\n    // With when the app runs for multi-zones support behind a proxy,\n    // the current page is trying to access this URL via assetPrefix.\n    // That's when the CORS support is needed.\n    const { preflight } = addCorsSupport(req, res)\n    if (preflight) {\n      return\n    }\n\n    // When a request comes in that is a page bundle, e.g. /_next/static/<buildid>/pages/index.js\n    // we have to compile the page using on-demand-entries, this middleware will handle doing that\n    // by adding the page to on-demand-entries, waiting till it's done\n    // and then the bundle will be served like usual by the actual route in server/index.js\n    const handlePageBundleRequest = async (\n      res: ServerResponse,\n      parsedUrl: UrlObject\n    ): Promise<{ finished?: true }> => {\n      const { pathname } = parsedUrl\n      const params = matchNextPageBundleRequest(pathname)\n      if (!params) {\n        return {}\n      }\n\n      if (params.buildId !== this.buildId) {\n        return {}\n      }\n\n      const page = `/${params.path.join('/')}`\n      if (page === '/_error' || BLOCKED_PAGES.indexOf(page) === -1) {\n        try {\n          await this.ensurePage(page)\n        } catch (error) {\n          await renderScriptError(res, error)\n          return { finished: true }\n        }\n\n        const bundlePath = join(\n          this.dir,\n          this.config.distDir,\n          'server/static/development/pages',\n          page + '.js'\n        )\n\n        // Make sure to 404 for AMP first pages\n        try {\n          const mod = require(bundlePath)\n          if (mod?.config?.amp === true) {\n            res.statusCode = 404\n            res.end()\n            return { finished: true }\n          }\n        } catch (_) {}\n\n        const errors = await this.getCompilationErrors(page)\n        if (errors.length > 0) {\n          await renderScriptError(res, errors[0])\n          return { finished: true }\n        }\n      }\n\n      return {}\n    }\n\n    const { finished } = await handlePageBundleRequest(res, parsedUrl)\n\n    for (const fn of this.middlewares) {\n      await new Promise((resolve, reject) => {\n        fn(req, res, (err: Error) => {\n          if (err) return reject(err)\n          resolve()\n        })\n      })\n    }\n\n    return { finished }\n  }\n\n  async clean(): Promise<void> {\n    return recursiveDelete(join(this.dir, this.config.distDir), /^cache/)\n  }\n\n  async getWebpackConfig() {\n    const pagePaths = await Promise.all([\n      findPageFile(this.pagesDir, '/_app', this.config.pageExtensions),\n      findPageFile(this.pagesDir, '/_document', this.config.pageExtensions),\n    ])\n\n    const pages = createPagesMapping(\n      pagePaths.filter((i) => i !== null) as string[],\n      this.config.pageExtensions\n    )\n    const entrypoints = createEntrypoints(\n      /* dev */ true,\n      pages,\n      'server',\n      this.buildId,\n      this.previewProps,\n      this.config,\n      []\n    )\n\n    let additionalClientEntrypoints: { [file: string]: string } = {}\n    additionalClientEntrypoints[CLIENT_STATIC_FILES_RUNTIME_AMP] =\n      `.${sep}` +\n      relativePath(\n        this.dir,\n        join(NEXT_PROJECT_ROOT_DIST_CLIENT, 'dev', 'amp-dev')\n      )\n\n    additionalClientEntrypoints[\n      CLIENT_STATIC_FILES_RUNTIME_REACT_REFRESH\n    ] = require.resolve(`@next/react-refresh-utils/runtime`)\n\n    return Promise.all([\n      getBaseWebpackConfig(this.dir, {\n        dev: true,\n        isServer: false,\n        config: this.config,\n        buildId: this.buildId,\n        pagesDir: this.pagesDir,\n        entrypoints: { ...entrypoints.client, ...additionalClientEntrypoints },\n      }),\n      getBaseWebpackConfig(this.dir, {\n        dev: true,\n        isServer: true,\n        config: this.config,\n        buildId: this.buildId,\n        pagesDir: this.pagesDir,\n        entrypoints: entrypoints.server,\n      }),\n    ])\n  }\n\n  async start(): Promise<void> {\n    await this.clean()\n\n    const configs = await this.getWebpackConfig()\n\n    const multiCompiler = webpack(configs)\n\n    const buildTools = await this.prepareBuildTools(multiCompiler)\n    this.assignBuildTools(buildTools)\n\n    // [Client, Server]\n    ;[\n      this.stats,\n      this.serverStats,\n    ] = ((await this.waitUntilValid()) as any).stats\n  }\n\n  async stop(\n    webpackDevMiddleware?: WebpackDevMiddleware.WebpackDevMiddleware\n  ): Promise<void> {\n    const middleware = webpackDevMiddleware || this.webpackDevMiddleware\n    if (middleware) {\n      return new Promise((resolve, reject) => {\n        ;(middleware.close as any)((err: any) => {\n          if (err) return reject(err)\n          resolve()\n        })\n      })\n    }\n  }\n\n  async reload(): Promise<void> {\n    this.stats = null\n    this.serverStats = null\n\n    await this.clean()\n\n    const configs = await this.getWebpackConfig()\n    const compiler = webpack(configs)\n\n    const buildTools = await this.prepareBuildTools(compiler)\n    // [Client, Server]\n    ;[\n      this.stats,\n      this.serverStats,\n    ] = ((await this.waitUntilValid()) as any).stats\n\n    const oldWebpackDevMiddleware = this.webpackDevMiddleware\n\n    this.assignBuildTools(buildTools)\n    await this.stop(oldWebpackDevMiddleware!)\n  }\n\n  assignBuildTools({\n    webpackDevMiddleware,\n    webpackHotMiddleware,\n    onDemandEntries,\n  }: {\n    webpackDevMiddleware: WebpackDevMiddleware.WebpackDevMiddleware\n    webpackHotMiddleware: NextHandleFunction & WebpackHotMiddleware.EventStream\n    onDemandEntries: any\n  }): void {\n    this.webpackDevMiddleware = webpackDevMiddleware\n    this.webpackHotMiddleware = webpackHotMiddleware\n    this.onDemandEntries = onDemandEntries\n    this.middlewares = [\n      webpackDevMiddleware,\n      // must come before hotMiddleware\n      onDemandEntries.middleware(),\n      webpackHotMiddleware,\n      errorOverlayMiddleware({ dir: this.dir }),\n      getOverlayMiddleware({\n        rootDirectory: this.dir,\n        stats: () => this.stats,\n        serverStats: () => this.serverStats,\n      }),\n    ]\n  }\n\n  async prepareBuildTools(multiCompiler: webpack.MultiCompiler) {\n    watchCompilers(multiCompiler.compilers[0], multiCompiler.compilers[1])\n\n    // This plugin watches for changes to _document.js and notifies the client side that it should reload the page\n    multiCompiler.compilers[1].hooks.done.tap(\n      'NextjsHotReloaderForServer',\n      (stats) => {\n        this.serverStats = stats\n        if (!this.initialized) {\n          return\n        }\n\n        const { compilation } = stats\n\n        // We only watch `_document` for changes on the server compilation\n        // the rest of the files will be triggered by the client compilation\n        const documentChunk = compilation.chunks.find(\n          (c) =>\n            c.name === normalize(`static/${this.buildId}/pages/_document.js`)\n        )\n        // If the document chunk can't be found we do nothing\n        if (!documentChunk) {\n          console.warn('_document.js chunk not found')\n          return\n        }\n\n        // Initial value\n        if (this.serverPrevDocumentHash === null) {\n          this.serverPrevDocumentHash = documentChunk.hash\n          return\n        }\n\n        // If _document.js didn't change we don't trigger a reload\n        if (documentChunk.hash === this.serverPrevDocumentHash) {\n          return\n        }\n\n        // Notify reload to reload the page, as _document.js was changed (different hash)\n        this.send('reloadPage')\n        this.serverPrevDocumentHash = documentChunk.hash\n      }\n    )\n\n    multiCompiler.compilers[0].hooks.done.tap(\n      'NextjsHotReloaderForClient',\n      (stats) => {\n        const { compilation } = stats\n        const chunkNames = new Set(\n          compilation.chunks\n            .map((c) => c.name)\n            .filter((name) => IS_BUNDLED_PAGE_REGEX.test(name))\n        )\n\n        if (this.initialized) {\n          // detect chunks which have to be replaced with a new template\n          // e.g, pages/index.js <-> pages/_error.js\n          const addedPages = diff(chunkNames, this.prevChunkNames!)\n          const removedPages = diff(this.prevChunkNames!, chunkNames)\n\n          if (addedPages.size > 0) {\n            for (const addedPage of addedPages) {\n              let page =\n                '/' + ROUTE_NAME_REGEX.exec(addedPage)![1].replace(/\\\\/g, '/')\n              page = page === '/index' ? '/' : page\n              this.send('addedPage', page)\n            }\n          }\n\n          if (removedPages.size > 0) {\n            for (const removedPage of removedPages) {\n              let page =\n                '/' + ROUTE_NAME_REGEX.exec(removedPage)![1].replace(/\\\\/g, '/')\n              page = page === '/index' ? '/' : page\n              this.send('removedPage', page)\n            }\n          }\n        }\n\n        this.initialized = true\n        this.stats = stats\n        this.prevChunkNames = chunkNames\n      }\n    )\n\n    // We don’t watch .git/ .next/ and node_modules for changes\n    const ignored = [\n      /[\\\\/]\\.git[\\\\/]/,\n      /[\\\\/]\\.next[\\\\/]/,\n      /[\\\\/]node_modules[\\\\/]/,\n    ]\n\n    let webpackDevMiddlewareConfig = {\n      publicPath: `/_next/static/webpack`,\n      noInfo: true,\n      logLevel: 'silent',\n      watchOptions: { ignored },\n      writeToDisk: true,\n    }\n\n    if (this.config.webpackDevMiddleware) {\n      console.log(\n        `> Using \"webpackDevMiddleware\" config function defined in ${this.config.configOrigin}.`\n      )\n      webpackDevMiddlewareConfig = this.config.webpackDevMiddleware(\n        webpackDevMiddlewareConfig\n      )\n    }\n\n    const webpackDevMiddleware = WebpackDevMiddleware(\n      multiCompiler,\n      webpackDevMiddlewareConfig\n    )\n\n    const webpackHotMiddleware = WebpackHotMiddleware(\n      multiCompiler.compilers[0],\n      {\n        path: '/_next/webpack-hmr',\n        log: false,\n        heartbeat: 2500,\n      }\n    )\n\n    const onDemandEntries = onDemandEntryHandler(\n      webpackDevMiddleware,\n      multiCompiler,\n      {\n        buildId: this.buildId,\n        pagesDir: this.pagesDir,\n        reload: this.reload.bind(this),\n        pageExtensions: this.config.pageExtensions,\n        ...(this.config.onDemandEntries as {\n          maxInactiveAge: number\n          pagesBufferLength: number\n        }),\n      }\n    )\n\n    return {\n      webpackDevMiddleware,\n      webpackHotMiddleware,\n      onDemandEntries,\n    }\n  }\n\n  waitUntilValid(\n    webpackDevMiddleware?: WebpackDevMiddleware.WebpackDevMiddleware\n  ): Promise<webpack.Stats> {\n    const middleware = webpackDevMiddleware || this.webpackDevMiddleware\n    return new Promise((resolve) => {\n      middleware!.waitUntilValid(resolve)\n    })\n  }\n\n  async getCompilationErrors(page: string) {\n    const normalizedPage = normalizePage(page)\n    // When we are reloading, we need to wait until it's reloaded properly.\n    await this.onDemandEntries.waitUntilReloaded()\n\n    if (this.stats.hasErrors()) {\n      const { compilation } = this.stats\n      const failedPages = erroredPages(compilation, {\n        enhanceName(name) {\n          return '/' + ROUTE_NAME_REGEX.exec(name)![1]\n        },\n      })\n\n      // If there is an error related to the requesting page we display it instead of the first error\n      if (\n        failedPages[normalizedPage] &&\n        failedPages[normalizedPage].length > 0\n      ) {\n        return failedPages[normalizedPage]\n      }\n\n      // If none were found we still have to show the other errors\n      return this.stats.compilation.errors\n    }\n\n    return []\n  }\n\n  send = (action: string, ...args: any[]): void => {\n    this.webpackHotMiddleware!.publish({ action, data: args })\n  }\n\n  async ensurePage(page: string) {\n    // Make sure we don't re-build or dispose prebuilt pages\n    if (page !== '/_error' && BLOCKED_PAGES.indexOf(page) !== -1) {\n      return\n    }\n    return this.onDemandEntries.ensurePage(page)\n  }\n}\n\nfunction diff(a: Set<any>, b: Set<any>) {\n  return new Set([...a].filter((v) => !b.has(v)))\n}\n"]}