{"version":3,"sources":["../../server/on-demand-entry-handler.ts"],"names":["ADDED","Symbol","BUILDING","BUILT","addEntry","compilation","context","name","entry","Promise","resolve","reject","dep","DynamicEntryPlugin","createDependency","err","onDemandEntryHandler","devMiddleware","multiCompiler","buildId","pagesDir","reload","pageExtensions","maxInactiveAge","pagesBufferLength","compilers","invalidator","Invalidator","entries","lastAccessPages","doneCallbacks","EventEmitter","reloading","stopped","reloadCallbacks","compiler","hooks","make","tapPromise","startBuilding","allEntries","Object","keys","map","page","match","API_ROUTE","absolutePagePath","pageExists","status","pageLoaderOpts","all","catch","console","error","findHardFailedPages","errors","filter","e","hasNoModuleFoundError","test","message","IS_BUNDLED_PAGE_REGEX","module","dependencies","length","chunks","reduce","a","b","c","pageName","ROUTE_NAME_REGEX","exec","normalizePage","getPagePathsFromEntrypoints","entrypoints","pagePaths","entrypoint","result","pagePath","push","done","tap","multiStats","clientStats","serverStats","stats","hardFailedPages","Set","lastActiveTime","Date","now","emit","doneBuilding","log","join","then","stop","stack","process","exit","disposeHandler","setInterval","disposeInactiveEntries","unref","clearInterval","handlePing","pg","entryInfo","toSend","invalid","success","includes","unshift","pop","waitUntilReloaded","once","ensurePage","normalizedPagePath","pageUrl","replace","RegExp","bundleFile","startsWith","require","posix","normalize","normalizedPage","handleCallback","Log","event","invalidate","middleware","req","res","next","statusCode","setHeader","url","end","query","runPing","data","write","JSON","stringify","pingInterval","on","disposingPages","forEach","unixPagePath","constructor","building","rebuildAgain","call"],"mappings":"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","sourcesContent":["import { EventEmitter } from 'events'\nimport { IncomingMessage, ServerResponse } from 'http'\nimport { join, posix } from 'path'\nimport { stringify } from 'querystring'\nimport { parse } from 'url'\nimport webpack from 'webpack'\nimport WebpackDevMiddleware from 'webpack-dev-middleware'\nimport DynamicEntryPlugin from 'webpack/lib/DynamicEntryPlugin'\nimport { isWriteable } from '../build/is-writeable'\nimport * as Log from '../build/output/log'\nimport { ClientPagesLoaderOptions } from '../build/webpack/loaders/next-client-pages-loader'\nimport { API_ROUTE } from '../lib/constants'\nimport {\n  IS_BUNDLED_PAGE_REGEX,\n  ROUTE_NAME_REGEX,\n} from '../next-server/lib/constants'\nimport { normalizePagePath } from '../next-server/server/normalize-page-path'\nimport { pageNotFoundError } from '../next-server/server/require'\nimport { findPageFile } from './lib/find-page-file'\n\nconst ADDED = Symbol('added')\nconst BUILDING = Symbol('building')\nconst BUILT = Symbol('built')\n\n// Based on https://github.com/webpack/webpack/blob/master/lib/DynamicEntryPlugin.js#L29-L37\nfunction addEntry(\n  compilation: webpack.compilation.Compilation,\n  context: string,\n  name: string,\n  entry: string[]\n) {\n  return new Promise((resolve, reject) => {\n    const dep = DynamicEntryPlugin.createDependency(entry, name)\n    compilation.addEntry(context, dep, name, (err: Error) => {\n      if (err) return reject(err)\n      resolve()\n    })\n  })\n}\n\nexport default function onDemandEntryHandler(\n  devMiddleware: WebpackDevMiddleware.WebpackDevMiddleware,\n  multiCompiler: webpack.MultiCompiler,\n  {\n    buildId,\n    pagesDir,\n    reload,\n    pageExtensions,\n    maxInactiveAge,\n    pagesBufferLength,\n  }: {\n    buildId: string\n    pagesDir: string\n    reload: any\n    pageExtensions: string[]\n    maxInactiveAge: number\n    pagesBufferLength: number\n  }\n) {\n  const { compilers } = multiCompiler\n  const invalidator = new Invalidator(devMiddleware, multiCompiler)\n  let entries: any = {}\n  let lastAccessPages = ['']\n  let doneCallbacks: EventEmitter | null = new EventEmitter()\n  let reloading = false\n  let stopped = false\n  let reloadCallbacks: EventEmitter | null = new EventEmitter()\n\n  for (const compiler of compilers) {\n    compiler.hooks.make.tapPromise(\n      'NextJsOnDemandEntries',\n      (compilation: webpack.compilation.Compilation) => {\n        invalidator.startBuilding()\n\n        const allEntries = Object.keys(entries).map(async (page) => {\n          if (compiler.name === 'client' && page.match(API_ROUTE)) {\n            return\n          }\n          const { name, absolutePagePath } = entries[page]\n          const pageExists = await isWriteable(absolutePagePath)\n          if (!pageExists) {\n            // page was removed\n            delete entries[page]\n            return\n          }\n\n          entries[page].status = BUILDING\n          const pageLoaderOpts: ClientPagesLoaderOptions = {\n            page,\n            absolutePagePath,\n          }\n          return addEntry(compilation, compiler.context, name, [\n            compiler.name === 'client'\n              ? `next-client-pages-loader?${stringify(pageLoaderOpts)}!`\n              : absolutePagePath,\n          ])\n        })\n\n        return Promise.all(allEntries).catch((err) => console.error(err))\n      }\n    )\n  }\n\n  function findHardFailedPages(errors: any[]) {\n    return errors\n      .filter((e) => {\n        // Make sure to only pick errors which marked with missing modules\n        const hasNoModuleFoundError =\n          /ENOENT/.test(e.message) || /Module not found/.test(e.message)\n        if (!hasNoModuleFoundError) return false\n\n        // The page itself is missing. So this is a failed page.\n        if (IS_BUNDLED_PAGE_REGEX.test(e.module.name)) return true\n\n        // No dependencies means this is a top level page.\n        // So this is a failed page.\n        return e.module.dependencies.length === 0\n      })\n      .map((e) => e.module.chunks)\n      .reduce((a, b) => [...a, ...b], [])\n      .map((c: any) => {\n        const pageName = ROUTE_NAME_REGEX.exec(c.name)![1]\n        return normalizePage(`/${pageName}`)\n      })\n  }\n\n  function getPagePathsFromEntrypoints(entrypoints: any) {\n    const pagePaths = []\n    for (const [, entrypoint] of entrypoints.entries()) {\n      const result = ROUTE_NAME_REGEX.exec(entrypoint.name)\n      if (!result) {\n        continue\n      }\n\n      const pagePath = result[1]\n\n      if (!pagePath) {\n        continue\n      }\n\n      pagePaths.push(pagePath)\n    }\n\n    return pagePaths\n  }\n\n  multiCompiler.hooks.done.tap('NextJsOnDemandEntries', (multiStats) => {\n    const [clientStats, serverStats] = multiStats.stats\n    const hardFailedPages = [\n      ...new Set([\n        ...findHardFailedPages(clientStats.compilation.errors),\n        ...findHardFailedPages(serverStats.compilation.errors),\n      ]),\n    ]\n    const pagePaths = new Set([\n      ...getPagePathsFromEntrypoints(clientStats.compilation.entrypoints),\n      ...getPagePathsFromEntrypoints(serverStats.compilation.entrypoints),\n    ])\n\n    // compilation.entrypoints is a Map object, so iterating over it 0 is the key and 1 is the value\n    for (const pagePath of pagePaths) {\n      const page = normalizePage('/' + pagePath)\n\n      const entry = entries[page]\n      if (!entry) {\n        continue\n      }\n\n      if (entry.status !== BUILDING) {\n        continue\n      }\n\n      entry.status = BUILT\n      entry.lastActiveTime = Date.now()\n      doneCallbacks!.emit(page)\n    }\n\n    invalidator.doneBuilding()\n\n    if (hardFailedPages.length > 0 && !reloading) {\n      console.log(\n        `> Reloading webpack due to inconsistant state of pages(s): ${hardFailedPages.join(\n          ', '\n        )}`\n      )\n      reloading = true\n      reload()\n        .then(() => {\n          console.log('> Webpack reloaded.')\n          reloadCallbacks!.emit('done')\n          stop()\n        })\n        .catch((err: Error) => {\n          console.error(`> Webpack reloading failed: ${err.message}`)\n          console.error(err.stack)\n          process.exit(1)\n        })\n    }\n  })\n\n  const disposeHandler = setInterval(function () {\n    if (stopped) return\n    disposeInactiveEntries(\n      devMiddleware,\n      entries,\n      lastAccessPages,\n      maxInactiveAge\n    )\n  }, 5000)\n\n  disposeHandler.unref()\n\n  function stop() {\n    clearInterval(disposeHandler)\n    stopped = true\n    doneCallbacks = null\n    reloadCallbacks = null\n  }\n\n  function handlePing(pg: string) {\n    const page = normalizePage(pg)\n    const entryInfo = entries[page]\n    let toSend\n\n    // If there's no entry, it may have been invalidated and needs to be re-built.\n    if (!entryInfo) {\n      // if (page !== lastEntry) client pings, but there's no entry for page\n      return { invalid: true }\n    }\n\n    // 404 is an on demand entry but when a new page is added we have to refresh the page\n    if (page === '/_error') {\n      toSend = { invalid: true }\n    } else {\n      toSend = { success: true }\n    }\n\n    // We don't need to maintain active state of anything other than BUILT entries\n    if (entryInfo.status !== BUILT) return\n\n    // If there's an entryInfo\n    if (!lastAccessPages.includes(page)) {\n      lastAccessPages.unshift(page)\n\n      // Maintain the buffer max length\n      if (lastAccessPages.length > pagesBufferLength) {\n        lastAccessPages.pop()\n      }\n    }\n    entryInfo.lastActiveTime = Date.now()\n    return toSend\n  }\n\n  return {\n    waitUntilReloaded() {\n      if (!reloading) return Promise.resolve(true)\n      return new Promise((resolve) => {\n        reloadCallbacks!.once('done', function () {\n          resolve()\n        })\n      })\n    },\n\n    async ensurePage(page: string) {\n      await this.waitUntilReloaded()\n      let normalizedPagePath: string\n      try {\n        normalizedPagePath = normalizePagePath(page)\n      } catch (err) {\n        console.error(err)\n        throw pageNotFoundError(page)\n      }\n\n      let pagePath = await findPageFile(\n        pagesDir,\n        normalizedPagePath,\n        pageExtensions\n      )\n\n      // Default the /_error route to the Next.js provided default page\n      if (page === '/_error' && pagePath === null) {\n        pagePath = 'next/dist/pages/_error'\n      }\n\n      if (pagePath === null) {\n        throw pageNotFoundError(normalizedPagePath)\n      }\n\n      let pageUrl = pagePath.replace(/\\\\/g, '/')\n\n      pageUrl = `${pageUrl[0] !== '/' ? '/' : ''}${pageUrl\n        .replace(new RegExp(`\\\\.+(?:${pageExtensions.join('|')})$`), '')\n        .replace(/\\/index$/, '')}`\n\n      pageUrl = pageUrl === '' ? '/' : pageUrl\n\n      const bundleFile = `${normalizePagePath(pageUrl)}.js`\n      const name = join('static', buildId, 'pages', bundleFile)\n      const absolutePagePath = pagePath.startsWith('next/dist/pages')\n        ? require.resolve(pagePath)\n        : join(pagesDir, pagePath)\n\n      page = posix.normalize(pageUrl)\n\n      return new Promise((resolve, reject) => {\n        // Makes sure the page that is being kept in on-demand-entries matches the webpack output\n        const normalizedPage = normalizePage(page)\n        const entryInfo = entries[normalizedPage]\n\n        if (entryInfo) {\n          if (entryInfo.status === BUILT) {\n            resolve()\n            return\n          }\n\n          if (entryInfo.status === BUILDING) {\n            doneCallbacks!.once(normalizedPage, handleCallback)\n            return\n          }\n        }\n\n        Log.event(`build page: ${normalizedPage}`)\n\n        entries[normalizedPage] = { name, absolutePagePath, status: ADDED }\n        doneCallbacks!.once(normalizedPage, handleCallback)\n\n        invalidator.invalidate()\n\n        function handleCallback(err: Error) {\n          if (err) return reject(err)\n          resolve()\n        }\n      })\n    },\n\n    middleware() {\n      return (req: IncomingMessage, res: ServerResponse, next: Function) => {\n        if (stopped) {\n          // If this handler is stopped, we need to reload the user's browser.\n          // So the user could connect to the actually running handler.\n          res.statusCode = 302\n          res.setHeader('Location', req.url!)\n          res.end('302')\n        } else if (reloading) {\n          // Webpack config is reloading. So, we need to wait until it's done and\n          // reload user's browser.\n          // So the user could connect to the new handler and webpack setup.\n          this.waitUntilReloaded().then(() => {\n            res.statusCode = 302\n            res.setHeader('Location', req.url!)\n            res.end('302')\n          })\n        } else {\n          if (!/^\\/_next\\/webpack-hmr/.test(req.url!)) return next()\n\n          const { query } = parse(req.url!, true)\n          const page = query.page\n          if (!page) return next()\n\n          const runPing = () => {\n            const data = handlePing(query.page as string)\n            if (!data) return\n            res.write('data: ' + JSON.stringify(data) + '\\n\\n')\n          }\n          const pingInterval = setInterval(() => runPing(), 5000)\n\n          req.on('close', () => {\n            clearInterval(pingInterval)\n          })\n          next()\n        }\n      }\n    },\n  }\n}\n\nfunction disposeInactiveEntries(\n  devMiddleware: WebpackDevMiddleware.WebpackDevMiddleware,\n  entries: any,\n  lastAccessPages: any,\n  maxInactiveAge: number\n) {\n  const disposingPages: any = []\n\n  Object.keys(entries).forEach((page) => {\n    const { lastActiveTime, status } = entries[page]\n\n    // This means this entry is currently building or just added\n    // We don't need to dispose those entries.\n    if (status !== BUILT) return\n\n    // We should not build the last accessed page even we didn't get any pings\n    // Sometimes, it's possible our XHR ping to wait before completing other requests.\n    // In that case, we should not dispose the current viewing page\n    if (lastAccessPages.includes(page)) return\n\n    if (Date.now() - lastActiveTime > maxInactiveAge) {\n      disposingPages.push(page)\n    }\n  })\n\n  if (disposingPages.length > 0) {\n    disposingPages.forEach((page: any) => {\n      delete entries[page]\n    })\n    // disposing inactive page(s)\n    devMiddleware.invalidate()\n  }\n}\n\n// /index and / is the same. So, we need to identify both pages as the same.\n// This also applies to sub pages as well.\nexport function normalizePage(page: string) {\n  const unixPagePath = page.replace(/\\\\/g, '/')\n  if (unixPagePath === '/index' || unixPagePath === '/') {\n    return '/'\n  }\n  return unixPagePath.replace(/\\/index$/, '')\n}\n\n// Make sure only one invalidation happens at a time\n// Otherwise, webpack hash gets changed and it'll force the client to reload.\nclass Invalidator {\n  private multiCompiler: webpack.MultiCompiler\n  private devMiddleware: WebpackDevMiddleware.WebpackDevMiddleware\n  private building: boolean\n  private rebuildAgain: boolean\n\n  constructor(\n    devMiddleware: WebpackDevMiddleware.WebpackDevMiddleware,\n    multiCompiler: webpack.MultiCompiler\n  ) {\n    this.multiCompiler = multiCompiler\n    this.devMiddleware = devMiddleware\n    // contains an array of types of compilers currently building\n    this.building = false\n    this.rebuildAgain = false\n  }\n\n  invalidate() {\n    // If there's a current build is processing, we won't abort it by invalidating.\n    // (If aborted, it'll cause a client side hard reload)\n    // But let it to invalidate just after the completion.\n    // So, it can re-build the queued pages at once.\n    if (this.building) {\n      this.rebuildAgain = true\n      return\n    }\n\n    this.building = true\n    // Work around a bug in webpack, calling `invalidate` on Watching.js\n    // doesn't trigger the invalid call used to keep track of the `.done` hook on multiCompiler\n    for (const compiler of this.multiCompiler.compilers) {\n      compiler.hooks.invalid.call()\n    }\n    this.devMiddleware.invalidate()\n  }\n\n  startBuilding() {\n    this.building = true\n  }\n\n  doneBuilding() {\n    this.building = false\n\n    if (this.rebuildAgain) {\n      this.rebuildAgain = false\n      this.invalidate()\n    }\n  }\n}\n"]}