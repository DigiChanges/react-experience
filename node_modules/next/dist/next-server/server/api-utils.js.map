{"version":3,"sources":["../../../next-server/server/api-utils.ts"],"names":["apiResolver","req","res","params","resolverModule","apiContext","onError","apiReq","apiRes","statusCode","end","config","bodyParser","api","externalResolver","setLazyProp","getCookieParser","getQueryParser","body","parseBody","sizeLimit","status","sendStatusCode","send","data","sendData","json","sendJson","setPreviewData","options","Object","assign","clearPreviewData","resolver","wasPiped","process","env","NODE_ENV","once","console","warn","url","err","ApiError","sendError","message","error","limit","contentType","headers","type","parameters","encoding","charset","buffer","e","toString","parseJson","qs","require","decode","str","length","JSON","parse","parseQuery","URL","searchParams","query","key","value","Array","isArray","push","parseCookie","header","cookie","join","getHeader","Buffer","isBuffer","setHeader","Stream","pipe","stringify","byteLength","jsonBody","COOKIE_NAME_PRERENDER_BYPASS","COOKIE_NAME_PRERENDER_DATA","SYMBOL_PREVIEW_DATA","Symbol","SYMBOL_CLEARED_COOKIES","tryGetPreviewData","getCookies","cookies","hasBypass","hasData","previewModeId","tokenPreviewData","jsonwebtoken","encryptedPreviewData","verify","previewModeSigningKey","decryptedPreviewData","from","previewModeEncryptionKey","defineProperty","enumerable","Error","payload","sign","algorithm","maxAge","undefined","expiresIn","serialize","previous","httpOnly","sameSite","secure","path","expires","Date","constructor","statusMessage","prop","getter","opts","configurable","optsReset","writable","get","set"],"mappings":"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","sourcesContent":["import { parse } from 'next/dist/compiled/content-type'\nimport { CookieSerializeOptions } from 'next/dist/compiled/cookie'\nimport { IncomingMessage, ServerResponse } from 'http'\nimport { PageConfig } from 'next/types'\nimport getRawBody from 'next/dist/compiled/raw-body'\nimport { Stream } from 'stream'\nimport { isResSent, NextApiRequest, NextApiResponse } from '../lib/utils'\nimport { decryptWithSecret, encryptWithSecret } from './crypto-utils'\nimport { interopDefault } from './load-components'\nimport { Params } from './router'\n\nexport type NextApiRequestCookies = { [key: string]: string }\nexport type NextApiRequestQuery = { [key: string]: string | string[] }\n\nexport type __ApiPreviewProps = {\n  previewModeId: string\n  previewModeEncryptionKey: string\n  previewModeSigningKey: string\n}\n\nexport async function apiResolver(\n  req: IncomingMessage,\n  res: ServerResponse,\n  params: any,\n  resolverModule: any,\n  apiContext: __ApiPreviewProps,\n  onError?: ({ err }: { err: any }) => Promise<void>\n) {\n  const apiReq = req as NextApiRequest\n  const apiRes = res as NextApiResponse\n\n  try {\n    if (!resolverModule) {\n      res.statusCode = 404\n      res.end('Not Found')\n      return\n    }\n    const config: PageConfig = resolverModule.config || {}\n    const bodyParser = config.api?.bodyParser !== false\n    const externalResolver = config.api?.externalResolver || false\n\n    // Parsing of cookies\n    setLazyProp({ req: apiReq }, 'cookies', getCookieParser(req))\n    // Parsing query string\n    setLazyProp({ req: apiReq, params }, 'query', getQueryParser(req))\n    // // Parsing of body\n    if (bodyParser) {\n      apiReq.body = await parseBody(\n        apiReq,\n        config.api && config.api.bodyParser && config.api.bodyParser.sizeLimit\n          ? config.api.bodyParser.sizeLimit\n          : '1mb'\n      )\n    }\n\n    apiRes.status = (statusCode) => sendStatusCode(apiRes, statusCode)\n    apiRes.send = (data) => sendData(apiRes, data)\n    apiRes.json = (data) => sendJson(apiRes, data)\n    apiRes.setPreviewData = (data, options = {}) =>\n      setPreviewData(apiRes, data, Object.assign({}, apiContext, options))\n    apiRes.clearPreviewData = () => clearPreviewData(apiRes)\n\n    const resolver = interopDefault(resolverModule)\n    let wasPiped = false\n\n    if (process.env.NODE_ENV !== 'production') {\n      // listen for pipe event and don't show resolve warning\n      res.once('pipe', () => (wasPiped = true))\n    }\n\n    // Call API route method\n    await resolver(req, res)\n\n    if (\n      process.env.NODE_ENV !== 'production' &&\n      !externalResolver &&\n      !isResSent(res) &&\n      !wasPiped\n    ) {\n      console.warn(\n        `API resolved without sending a response for ${req.url}, this may result in stalled requests.`\n      )\n    }\n  } catch (err) {\n    if (err instanceof ApiError) {\n      sendError(apiRes, err.statusCode, err.message)\n    } else {\n      console.error(err)\n      if (onError) await onError({ err })\n      sendError(apiRes, 500, 'Internal Server Error')\n    }\n  }\n}\n\n/**\n * Parse incoming message like `json` or `urlencoded`\n * @param req request object\n */\nexport async function parseBody(\n  req: NextApiRequest,\n  limit: string | number\n): Promise<any> {\n  const contentType = parse(req.headers['content-type'] || 'text/plain')\n  const { type, parameters } = contentType\n  const encoding = parameters.charset || 'utf-8'\n\n  let buffer\n\n  try {\n    buffer = await getRawBody(req, { encoding, limit })\n  } catch (e) {\n    if (e.type === 'entity.too.large') {\n      throw new ApiError(413, `Body exceeded ${limit} limit`)\n    } else {\n      throw new ApiError(400, 'Invalid body')\n    }\n  }\n\n  const body = buffer.toString()\n\n  if (type === 'application/json' || type === 'application/ld+json') {\n    return parseJson(body)\n  } else if (type === 'application/x-www-form-urlencoded') {\n    const qs = require('querystring')\n    return qs.decode(body)\n  } else {\n    return body\n  }\n}\n\n/**\n * Parse `JSON` and handles invalid `JSON` strings\n * @param str `JSON` string\n */\nfunction parseJson(str: string): object {\n  if (str.length === 0) {\n    // special-case empty json body, as it's a common client-side mistake\n    return {}\n  }\n\n  try {\n    return JSON.parse(str)\n  } catch (e) {\n    throw new ApiError(400, 'Invalid JSON')\n  }\n}\n\n/**\n * Parsing query arguments from request `url` string\n * @param url of request\n * @returns Object with key name of query argument and its value\n */\nexport function getQueryParser({ url }: IncomingMessage) {\n  return function parseQuery(): NextApiRequestQuery {\n    const { URL } = require('url')\n    // we provide a placeholder base url because we only want searchParams\n    const params = new URL(url, 'https://n').searchParams\n\n    const query: { [key: string]: string | string[] } = {}\n    for (const [key, value] of params) {\n      if (query[key]) {\n        if (Array.isArray(query[key])) {\n          ;(query[key] as string[]).push(value)\n        } else {\n          query[key] = [query[key], value]\n        }\n      } else {\n        query[key] = value\n      }\n    }\n\n    return query\n  }\n}\n\n/**\n * Parse cookies from `req` header\n * @param req request object\n */\nexport function getCookieParser(req: IncomingMessage) {\n  return function parseCookie(): NextApiRequestCookies {\n    const header: undefined | string | string[] = req.headers.cookie\n\n    if (!header) {\n      return {}\n    }\n\n    const { parse } = require('next/dist/compiled/cookie')\n    return parse(Array.isArray(header) ? header.join(';') : header)\n  }\n}\n\n/**\n *\n * @param res response object\n * @param statusCode `HTTP` status code of response\n */\nexport function sendStatusCode(\n  res: NextApiResponse,\n  statusCode: number\n): NextApiResponse<any> {\n  res.statusCode = statusCode\n  return res\n}\n\n/**\n * Send `any` body to response\n * @param res response object\n * @param body of response\n */\nexport function sendData(res: NextApiResponse, body: any): void {\n  if (body === null) {\n    res.end()\n    return\n  }\n\n  const contentType = res.getHeader('Content-Type')\n\n  if (Buffer.isBuffer(body)) {\n    if (!contentType) {\n      res.setHeader('Content-Type', 'application/octet-stream')\n    }\n    res.setHeader('Content-Length', body.length)\n    res.end(body)\n    return\n  }\n\n  if (body instanceof Stream) {\n    if (!contentType) {\n      res.setHeader('Content-Type', 'application/octet-stream')\n    }\n    body.pipe(res)\n    return\n  }\n\n  let str = body\n\n  // Stringify JSON body\n  if (\n    typeof body === 'object' ||\n    typeof body === 'number' ||\n    typeof body === 'boolean'\n  ) {\n    str = JSON.stringify(body)\n    res.setHeader('Content-Type', 'application/json; charset=utf-8')\n  }\n\n  res.setHeader('Content-Length', Buffer.byteLength(str))\n  res.end(str)\n}\n\n/**\n * Send `JSON` object\n * @param res response object\n * @param jsonBody of data\n */\nexport function sendJson(res: NextApiResponse, jsonBody: any): void {\n  // Set header to application/json\n  res.setHeader('Content-Type', 'application/json; charset=utf-8')\n\n  // Use send to handle request\n  res.send(jsonBody)\n}\n\nconst COOKIE_NAME_PRERENDER_BYPASS = `__prerender_bypass`\nconst COOKIE_NAME_PRERENDER_DATA = `__next_preview_data`\n\nexport const SYMBOL_PREVIEW_DATA = Symbol(COOKIE_NAME_PRERENDER_DATA)\nconst SYMBOL_CLEARED_COOKIES = Symbol(COOKIE_NAME_PRERENDER_BYPASS)\n\nexport function tryGetPreviewData(\n  req: IncomingMessage,\n  res: ServerResponse,\n  options: __ApiPreviewProps\n): object | string | false {\n  // Read cached preview data if present\n  if (SYMBOL_PREVIEW_DATA in req) {\n    return (req as any)[SYMBOL_PREVIEW_DATA] as any\n  }\n\n  const getCookies = getCookieParser(req)\n  let cookies: NextApiRequestCookies\n  try {\n    cookies = getCookies()\n  } catch {\n    // TODO: warn\n    return false\n  }\n\n  const hasBypass = COOKIE_NAME_PRERENDER_BYPASS in cookies\n  const hasData = COOKIE_NAME_PRERENDER_DATA in cookies\n\n  // Case: neither cookie is set.\n  if (!(hasBypass || hasData)) {\n    return false\n  }\n\n  // Case: one cookie is set, but not the other.\n  if (hasBypass !== hasData) {\n    clearPreviewData(res as NextApiResponse)\n    return false\n  }\n\n  // Case: preview session is for an old build.\n  if (cookies[COOKIE_NAME_PRERENDER_BYPASS] !== options.previewModeId) {\n    clearPreviewData(res as NextApiResponse)\n    return false\n  }\n\n  const tokenPreviewData = cookies[COOKIE_NAME_PRERENDER_DATA]\n\n  const jsonwebtoken = require('next/dist/compiled/jsonwebtoken') as typeof import('jsonwebtoken')\n  let encryptedPreviewData: {\n    data: string\n  }\n  try {\n    encryptedPreviewData = jsonwebtoken.verify(\n      tokenPreviewData,\n      options.previewModeSigningKey\n    ) as typeof encryptedPreviewData\n  } catch {\n    // TODO: warn\n    clearPreviewData(res as NextApiResponse)\n    return false\n  }\n\n  const decryptedPreviewData = decryptWithSecret(\n    Buffer.from(options.previewModeEncryptionKey),\n    encryptedPreviewData.data\n  )\n\n  try {\n    // TODO: strict runtime type checking\n    const data = JSON.parse(decryptedPreviewData)\n    // Cache lookup\n    Object.defineProperty(req, SYMBOL_PREVIEW_DATA, {\n      value: data,\n      enumerable: false,\n    })\n    return data\n  } catch {\n    return false\n  }\n}\n\nfunction setPreviewData<T>(\n  res: NextApiResponse<T>,\n  data: object | string, // TODO: strict runtime type checking\n  options: {\n    maxAge?: number\n  } & __ApiPreviewProps\n): NextApiResponse<T> {\n  if (\n    typeof options.previewModeId !== 'string' ||\n    options.previewModeId.length < 16\n  ) {\n    throw new Error('invariant: invalid previewModeId')\n  }\n  if (\n    typeof options.previewModeEncryptionKey !== 'string' ||\n    options.previewModeEncryptionKey.length < 16\n  ) {\n    throw new Error('invariant: invalid previewModeEncryptionKey')\n  }\n  if (\n    typeof options.previewModeSigningKey !== 'string' ||\n    options.previewModeSigningKey.length < 16\n  ) {\n    throw new Error('invariant: invalid previewModeSigningKey')\n  }\n\n  const jsonwebtoken = require('next/dist/compiled/jsonwebtoken') as typeof import('jsonwebtoken')\n\n  const payload = jsonwebtoken.sign(\n    {\n      data: encryptWithSecret(\n        Buffer.from(options.previewModeEncryptionKey),\n        JSON.stringify(data)\n      ),\n    },\n    options.previewModeSigningKey,\n    {\n      algorithm: 'HS256',\n      ...(options.maxAge !== undefined\n        ? { expiresIn: options.maxAge }\n        : undefined),\n    }\n  )\n\n  // limit preview mode cookie to 2KB since we shouldn't store too much\n  // data here and browsers drop cookies over 4KB\n  if (payload.length > 2048) {\n    throw new Error(\n      `Preview data is limited to 2KB currently, reduce how much data you are storing as preview data to continue`\n    )\n  }\n\n  const {\n    serialize,\n  } = require('next/dist/compiled/cookie') as typeof import('cookie')\n  const previous = res.getHeader('Set-Cookie')\n  res.setHeader(`Set-Cookie`, [\n    ...(typeof previous === 'string'\n      ? [previous]\n      : Array.isArray(previous)\n      ? previous\n      : []),\n    serialize(COOKIE_NAME_PRERENDER_BYPASS, options.previewModeId, {\n      httpOnly: true,\n      sameSite: process.env.NODE_ENV !== 'development' ? 'none' : 'lax',\n      secure: process.env.NODE_ENV !== 'development',\n      path: '/',\n      ...(options.maxAge !== undefined\n        ? ({ maxAge: options.maxAge } as CookieSerializeOptions)\n        : undefined),\n    }),\n    serialize(COOKIE_NAME_PRERENDER_DATA, payload, {\n      httpOnly: true,\n      sameSite: process.env.NODE_ENV !== 'development' ? 'none' : 'lax',\n      secure: process.env.NODE_ENV !== 'development',\n      path: '/',\n      ...(options.maxAge !== undefined\n        ? ({ maxAge: options.maxAge } as CookieSerializeOptions)\n        : undefined),\n    }),\n  ])\n  return res\n}\n\nfunction clearPreviewData<T>(res: NextApiResponse<T>): NextApiResponse<T> {\n  if (SYMBOL_CLEARED_COOKIES in res) {\n    return res\n  }\n\n  const {\n    serialize,\n  } = require('next/dist/compiled/cookie') as typeof import('cookie')\n  const previous = res.getHeader('Set-Cookie')\n  res.setHeader(`Set-Cookie`, [\n    ...(typeof previous === 'string'\n      ? [previous]\n      : Array.isArray(previous)\n      ? previous\n      : []),\n    serialize(COOKIE_NAME_PRERENDER_BYPASS, '', {\n      // To delete a cookie, set `expires` to a date in the past:\n      // https://tools.ietf.org/html/rfc6265#section-4.1.1\n      // `Max-Age: 0` is not valid, thus ignored, and the cookie is persisted.\n      expires: new Date(0),\n      httpOnly: true,\n      sameSite: process.env.NODE_ENV !== 'development' ? 'none' : 'lax',\n      secure: process.env.NODE_ENV !== 'development',\n      path: '/',\n    }),\n    serialize(COOKIE_NAME_PRERENDER_DATA, '', {\n      // To delete a cookie, set `expires` to a date in the past:\n      // https://tools.ietf.org/html/rfc6265#section-4.1.1\n      // `Max-Age: 0` is not valid, thus ignored, and the cookie is persisted.\n      expires: new Date(0),\n      httpOnly: true,\n      sameSite: process.env.NODE_ENV !== 'development' ? 'none' : 'lax',\n      secure: process.env.NODE_ENV !== 'development',\n      path: '/',\n    }),\n  ])\n\n  Object.defineProperty(res, SYMBOL_CLEARED_COOKIES, {\n    value: true,\n    enumerable: false,\n  })\n  return res\n}\n\n/**\n * Custom error class\n */\nexport class ApiError extends Error {\n  readonly statusCode: number\n\n  constructor(statusCode: number, message: string) {\n    super(message)\n    this.statusCode = statusCode\n  }\n}\n\n/**\n * Sends error in `response`\n * @param res response object\n * @param statusCode of response\n * @param message of response\n */\nexport function sendError(\n  res: NextApiResponse,\n  statusCode: number,\n  message: string\n): void {\n  res.statusCode = statusCode\n  res.statusMessage = message\n  res.end(message)\n}\n\ninterface LazyProps {\n  req: NextApiRequest\n  params?: Params | boolean\n}\n\n/**\n * Execute getter function only if its needed\n * @param LazyProps `req` and `params` for lazyProp\n * @param prop name of property\n * @param getter function to get data\n */\nexport function setLazyProp<T>(\n  { req, params }: LazyProps,\n  prop: string,\n  getter: () => T\n): void {\n  const opts = { configurable: true, enumerable: true }\n  const optsReset = { ...opts, writable: true }\n\n  Object.defineProperty(req, prop, {\n    ...opts,\n    get: () => {\n      let value = getter()\n      if (params && typeof params !== 'boolean') {\n        value = { ...value, ...params }\n      }\n      // we set the property on the object to avoid recalculating it\n      Object.defineProperty(req, prop, { ...optsReset, value })\n      return value\n    },\n    set: (value) => {\n      Object.defineProperty(req, prop, { ...optsReset, value })\n    },\n  })\n}\n"]}