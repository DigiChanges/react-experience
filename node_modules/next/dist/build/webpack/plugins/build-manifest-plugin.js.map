{"version":3,"sources":["../../../../build/webpack/plugins/build-manifest-plugin.ts"],"names":["generateClientManifest","assetMap","isModern","clientManifest","appDependencies","Set","pages","Object","entries","forEach","page","dependencies","filteredDeps","filter","dep","has","endsWith","length","BuildManifestPlugin","constructor","options","buildId","modern","apply","compiler","hooks","emit","tapAsync","compilation","callback","chunks","devFiles","lowPriorityFiles","mainJsChunk","find","c","name","CLIENT_STATIC_FILES_RUNTIME_MAIN","mainJsFiles","files","file","test","polyfillChunk","CLIENT_STATIC_FILES_RUNTIME_POLYFILLS","polyfillFiles","reactRefreshChunk","CLIENT_STATIC_FILES_RUNTIME_REACT_REFRESH","push","filePath","keys","assets","path","replace","entrypoint","entrypoints","result","ROUTE_NAME_REGEX","exec","pagePath","filesForEntry","getFiles","IS_BUNDLED_PAGE_REGEX","CLIENT_STATIC_FILES_PATH","srcEmptySsgManifest","ssgManifestPath","RawSource","ssgManifestPathModern","sort","reduce","a","BUILD_MANIFEST","JSON","stringify","clientManifestPath","modernClientManifestPath"],"mappings":"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","sourcesContent":["import devalue from 'next/dist/compiled/devalue'\nimport { Compiler } from 'webpack'\nimport { RawSource } from 'webpack-sources'\nimport {\n  BUILD_MANIFEST,\n  CLIENT_STATIC_FILES_PATH,\n  CLIENT_STATIC_FILES_RUNTIME_MAIN,\n  CLIENT_STATIC_FILES_RUNTIME_POLYFILLS,\n  CLIENT_STATIC_FILES_RUNTIME_REACT_REFRESH,\n  IS_BUNDLED_PAGE_REGEX,\n  ROUTE_NAME_REGEX,\n} from '../../../next-server/lib/constants'\nimport { BuildManifest } from '../../../next-server/server/get-page-files'\n\n// This function takes the asset map generated in BuildManifestPlugin and creates a\n// reduced version to send to the client.\nconst generateClientManifest = (\n  assetMap: BuildManifest,\n  isModern: boolean\n): string => {\n  const clientManifest: { [s: string]: string[] } = {}\n  const appDependencies = new Set(assetMap.pages['/_app'])\n\n  Object.entries(assetMap.pages).forEach(([page, dependencies]) => {\n    if (page === '/_app' || page === '/_polyfills') return\n    // Filter out dependencies in the _app entry, because those will have already\n    // been loaded by the client prior to a navigation event\n    const filteredDeps = dependencies.filter(\n      (dep) =>\n        !appDependencies.has(dep) &&\n        (!dep.endsWith('.js') || dep.endsWith('.module.js') === isModern)\n    )\n\n    // The manifest can omit the page if it has no requirements\n    if (filteredDeps.length) {\n      clientManifest[page] = filteredDeps\n    }\n  })\n  return devalue(clientManifest)\n}\n\n// This plugin creates a build-manifest.json for all assets that are being output\n// It has a mapping of \"entry\" filename to real filename. Because the real filename can be hashed in production\nexport default class BuildManifestPlugin {\n  private buildId: string\n  private clientManifest: boolean\n  private modern: boolean\n\n  constructor(options: {\n    buildId: string\n    clientManifest: boolean\n    modern: boolean\n  }) {\n    this.buildId = options.buildId\n    this.clientManifest = options.clientManifest\n    this.modern = options.modern\n  }\n\n  apply(compiler: Compiler) {\n    compiler.hooks.emit.tapAsync(\n      'NextJsBuildManifest',\n      (compilation, callback) => {\n        const { chunks } = compilation\n        const assetMap: BuildManifest = {\n          devFiles: [],\n          lowPriorityFiles: [],\n          pages: { '/_app': [] },\n        }\n\n        const mainJsChunk = chunks.find(\n          (c) => c.name === CLIENT_STATIC_FILES_RUNTIME_MAIN\n        )\n        const mainJsFiles: string[] =\n          mainJsChunk && mainJsChunk.files.length > 0\n            ? mainJsChunk.files.filter((file: string) => /\\.js$/.test(file))\n            : []\n\n        const polyfillChunk = chunks.find(\n          (c) => c.name === CLIENT_STATIC_FILES_RUNTIME_POLYFILLS\n        )\n        const polyfillFiles: string[] = polyfillChunk ? polyfillChunk.files : []\n\n        const reactRefreshChunk = chunks.find(\n          (c) => c.name === CLIENT_STATIC_FILES_RUNTIME_REACT_REFRESH\n        )\n        assetMap.devFiles.push(...(reactRefreshChunk?.files ?? []))\n\n        for (const filePath of Object.keys(compilation.assets)) {\n          const path = filePath.replace(/\\\\/g, '/')\n          if (/^static\\/development\\/dll\\//.test(path)) {\n            assetMap.devFiles.push(path)\n          }\n        }\n\n        // compilation.entrypoints is a Map object, so iterating over it 0 is the key and 1 is the value\n        for (const [, entrypoint] of compilation.entrypoints.entries()) {\n          const result = ROUTE_NAME_REGEX.exec(entrypoint.name)\n          if (!result) {\n            continue\n          }\n\n          const pagePath = result[1]\n\n          if (!pagePath) {\n            continue\n          }\n\n          const filesForEntry: string[] = []\n\n          // getFiles() - helper function to read the files for an entrypoint from stats object\n          for (const file of entrypoint.getFiles()) {\n            if (/\\.map$/.test(file) || /\\.hot-update\\.js$/.test(file)) {\n              continue\n            }\n\n            // Only `.js` and `.css` files are added for now. In the future we can also handle other file types.\n            if (!/\\.js$/.test(file) && !/\\.css$/.test(file)) {\n              continue\n            }\n\n            // The page bundles are manually added to _document.js as they need extra properties\n            if (IS_BUNDLED_PAGE_REGEX.exec(file)) {\n              continue\n            }\n\n            filesForEntry.push(file.replace(/\\\\/g, '/'))\n          }\n\n          assetMap.pages[`/${pagePath.replace(/\\\\/g, '/')}`] = [\n            ...filesForEntry,\n            ...mainJsFiles,\n          ]\n        }\n\n        if (typeof assetMap.pages['/index'] !== 'undefined') {\n          assetMap.pages['/'] = assetMap.pages['/index']\n        }\n\n        // Create a separate entry  for polyfills\n        assetMap.pages['/_polyfills'] = polyfillFiles\n\n        // Add the runtime build manifest file (generated later in this file)\n        // as a dependency for the app. If the flag is false, the file won't be\n        // downloaded by the client.\n        if (this.clientManifest) {\n          assetMap.lowPriorityFiles.push(\n            `${CLIENT_STATIC_FILES_PATH}/${this.buildId}/_buildManifest.js`\n          )\n          if (this.modern) {\n            assetMap.lowPriorityFiles.push(\n              `${CLIENT_STATIC_FILES_PATH}/${this.buildId}/_buildManifest.module.js`\n            )\n          }\n        }\n\n        // Add the runtime ssg manifest file as a lazy-loaded file dependency.\n        // We also stub this file out for development mode (when it is not\n        // generated).\n        const srcEmptySsgManifest = `self.__SSG_MANIFEST=new Set;self.__SSG_MANIFEST_CB&&self.__SSG_MANIFEST_CB()`\n\n        const ssgManifestPath = `${CLIENT_STATIC_FILES_PATH}/${this.buildId}/_ssgManifest.js`\n        assetMap.lowPriorityFiles.push(ssgManifestPath)\n        compilation.assets[ssgManifestPath] = new RawSource(srcEmptySsgManifest)\n\n        if (this.modern) {\n          const ssgManifestPathModern = `${CLIENT_STATIC_FILES_PATH}/${this.buildId}/_ssgManifest.module.js`\n          assetMap.lowPriorityFiles.push(ssgManifestPathModern)\n          compilation.assets[ssgManifestPathModern] = new RawSource(\n            srcEmptySsgManifest\n          )\n        }\n\n        assetMap.pages = Object.keys(assetMap.pages)\n          .sort()\n          // eslint-disable-next-line\n          .reduce((a, c) => ((a[c] = assetMap.pages[c]), a), {} as any)\n\n        compilation.assets[BUILD_MANIFEST] = new RawSource(\n          JSON.stringify(assetMap, null, 2)\n        )\n\n        if (this.clientManifest) {\n          const clientManifestPath = `${CLIENT_STATIC_FILES_PATH}/${this.buildId}/_buildManifest.js`\n\n          compilation.assets[clientManifestPath] = new RawSource(\n            `self.__BUILD_MANIFEST = ${generateClientManifest(\n              assetMap,\n              false\n            )};self.__BUILD_MANIFEST_CB && self.__BUILD_MANIFEST_CB()`\n          )\n\n          if (this.modern) {\n            const modernClientManifestPath = `${CLIENT_STATIC_FILES_PATH}/${this.buildId}/_buildManifest.module.js`\n\n            compilation.assets[modernClientManifestPath] = new RawSource(\n              `self.__BUILD_MANIFEST = ${generateClientManifest(\n                assetMap,\n                true\n              )};self.__BUILD_MANIFEST_CB && self.__BUILD_MANIFEST_CB()`\n            )\n          }\n        }\n        callback()\n      }\n    )\n  }\n}\n"]}