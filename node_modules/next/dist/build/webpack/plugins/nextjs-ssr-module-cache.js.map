{"version":3,"sources":["../../../../build/webpack/plugins/nextjs-ssr-module-cache.ts"],"names":["SSR_MODULE_CACHE_FILENAME","NextJsSsrImportPlugin","constructor","options","apply","compiler","outputPath","hooks","emit","tapAsync","compilation","callback","assets","RawSource","tap","mainTemplate","localVars","intercept","register","tapInfo","name","originalFn","fn","source","chunk","IS_BUNDLED_PAGE_REGEX","exec","pagePath","relativePathToBaseDir","relativePathToBaseDirNormalized","replace","webpack","Template","asString"],"mappings":"4DAAA,wDACA,+CACA,0BACA,6D,mFAEA,KAAMA,CAAAA,yBAAyB,CAAG,qBAAlC,CAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACe,KAAMC,CAAAA,qBAAsB,CAGzCC,WAAW,CAACC,OAAD,CAAkC,MAFrCA,OAEqC,QAC3C,KAAKA,OAAL,CAAeA,OAAf,CACD,CACDC,KAAK,CAACC,QAAD,CAA6B,CAChC,KAAM,CAAEC,UAAF,EAAiB,KAAKH,OAA5B,CACAE,QAAQ,CAACE,KAAT,CAAeC,IAAf,CAAoBC,QAApB,CACE,sBADF,CAEE,CAACC,WAAD,CAAcC,QAAd,GAA2B,CACzBD,WAAW,CAACE,MAAZ,CAAmBZ,yBAAnB,EAAgD,GAAIa,0BAAJ,CAAe;;;OAAf,CAAhD,CAIAF,QAAQ,GACT,CARH,EAUAN,QAAQ,CAACE,KAAT,CAAeG,WAAf,CAA2BI,GAA3B,CACE,sBADF,CAEGJ,WAAD,EAAsB,CACpBA,WAAW,CAACK,YAAZ,CAAyBR,KAAzB,CAA+BS,SAA/B,CAAyCC,SAAzC,CAAmD,CACjDC,QAAQ,CAACC,OAAD,CAAe,CACrB,GAAIA,OAAO,CAACC,IAAR,GAAiB,cAArB,CAAqC,CACnC,KAAMC,CAAAA,UAAU,CAAGF,OAAO,CAACG,EAA3B,CACAH,OAAO,CAACG,EAAR,CAAa,CAACC,MAAD,CAAcC,KAAd,GAA6B,CACxC;AACA;AACA;AACA,GAAI,CAACC,iCAAsBC,IAAtB,CAA2BF,KAAK,CAACJ,IAAjC,CAAL,CAA6C,CAC3C,MAAOC,CAAAA,UAAU,CAACE,MAAD,CAASC,KAAT,CAAjB,CACD,CACD,KAAMG,CAAAA,QAAQ,CAAG,eAAKrB,UAAL,CAAiB,kBAAQkB,KAAK,CAACJ,IAAd,CAAjB,CAAjB,CACA,GAAIQ,CAAAA,qBAAqB,CAAG,mBAC1BD,QAD0B,CAE1B,eAAKrB,UAAL,CAAiBN,yBAAjB,CAF0B,CAA5B,CAKA;AACA;AACA,KAAM6B,CAAAA,+BAA+B,CAAGD,qBAAqB,CAACE,OAAtB,CACtC,KADsC,CAEtC,GAFsC,CAAxC,CAIA,MAAQC,iBAAD,CAAiBC,QAAjB,CAA0BC,QAA1B,CAAmC,CACxCV,MADwC,CAExC,qBAFwC,CAGvC,mCAAkCM,+BAAgC,KAH3B,CAAnC,CAAP,CAKD,CAxBD,CAyBD,CACD,MAAOV,CAAAA,OAAP,CACD,CA/BgD,CAAnD,EAiCD,CApCH,EAsCD,CAxDwC,C","sourcesContent":["import webpack from 'webpack'\nimport { RawSource } from 'webpack-sources'\nimport { join, relative, dirname } from 'path'\nimport { IS_BUNDLED_PAGE_REGEX } from '../../../next-server/lib/constants'\n\nconst SSR_MODULE_CACHE_FILENAME = 'ssr-module-cache.js'\n\n// By default webpack keeps initialized modules per-module.\n// This means that if you have 2 entrypoints loaded into the same app\n// they will *not* share the same instance\n// This creates many issues when developers / libraries rely on the singleton pattern\n// As this pattern assumes every module will have 1 instance\n// This plugin overrides webpack's code generation step to replace `installedModules`\n// The replacement is a require for a file that's also generated here that only exports an empty object\n// Because of Node.js's single instance modules this makes webpack share all initialized instances\n// Do note that this module is only geared towards the `node` compilation target.\n// For the client side compilation we use `runtimeChunk: 'single'`\nexport default class NextJsSsrImportPlugin {\n  private options: { outputPath: string }\n\n  constructor(options: { outputPath: string }) {\n    this.options = options\n  }\n  apply(compiler: webpack.Compiler) {\n    const { outputPath } = this.options\n    compiler.hooks.emit.tapAsync(\n      'NextJsSSRModuleCache',\n      (compilation, callback) => {\n        compilation.assets[SSR_MODULE_CACHE_FILENAME] = new RawSource(`\n      /* This cache is used by webpack for instantiated modules */\n      module.exports = {}\n      `)\n        callback()\n      }\n    )\n    compiler.hooks.compilation.tap(\n      'NextJsSSRModuleCache',\n      (compilation: any) => {\n        compilation.mainTemplate.hooks.localVars.intercept({\n          register(tapInfo: any) {\n            if (tapInfo.name === 'MainTemplate') {\n              const originalFn = tapInfo.fn\n              tapInfo.fn = (source: any, chunk: any) => {\n                // If the chunk is not part of the pages directory we have to keep the original behavior,\n                // otherwise webpack will error out when the file is used before the compilation finishes\n                // this is the case with mini-css-extract-plugin\n                if (!IS_BUNDLED_PAGE_REGEX.exec(chunk.name)) {\n                  return originalFn(source, chunk)\n                }\n                const pagePath = join(outputPath, dirname(chunk.name))\n                let relativePathToBaseDir = relative(\n                  pagePath,\n                  join(outputPath, SSR_MODULE_CACHE_FILENAME)\n                )\n\n                // Make sure even in windows, the path looks like in unix\n                // Node.js require system will convert it accordingly\n                const relativePathToBaseDirNormalized = relativePathToBaseDir.replace(\n                  /\\\\/g,\n                  '/'\n                )\n                return (webpack as any).Template.asString([\n                  source,\n                  '// The module cache',\n                  `var installedModules = require('${relativePathToBaseDirNormalized}');`,\n                ])\n              }\n            }\n            return tapInfo\n          },\n        })\n      }\n    )\n  }\n}\n"]}