{"version":3,"sources":["../../../../../build/webpack/plugins/webpack-conformance-plugin/index.ts"],"names":["WebpackConformancePlugin","constructor","options","tests","errors","warnings","compiler","buildStartedHandler","compilation","callback","buildStartedResults","map","test","buildStared","result","IConformanceTestStatus","SUCCESS","gatherResults","buildCompletedHandler","cb","buildCompletedResults","buildCompleted","assets","push","parserHandler","factory","JS_TYPES","collectedVisitors","Map","forEach","getAstNode","getAstNodeCallbacks","has","visitor","set","get","inspectNode","type","hooks","parser","for","tap","name","program","ast","visitors","that","visitorKey","keys","path","callbacks","request","state","module","outcome","traverse","results","FAILED","apply","make","tapAsync","emit","normalModuleFactory"],"mappings":"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","sourcesContent":["import { Compiler, compilation } from 'webpack'\nimport {\n  IConformanceTestResult,\n  IWebpackConformanceTest,\n  IConformanceAnomaly,\n  IGetAstNodeResult,\n  NodeInspector,\n  IConformanceTestStatus,\n} from './TestInterface'\nimport { NodePath } from 'ast-types/lib/node-path'\nimport { visit } from 'next/dist/compiled/recast'\n\nexport { MinificationConformanceCheck } from './checks/minification-conformance-check'\nexport { ReactSyncScriptsConformanceCheck } from './checks/react-sync-scripts-conformance-check'\nexport { DuplicatePolyfillsConformanceCheck } from './checks/duplicate-polyfills-conformance-check'\nexport { GranularChunksConformanceCheck } from './checks/granular-chunks-conformance'\n\nexport interface IWebpackConformancePluginOptions {\n  tests: IWebpackConformanceTest[]\n}\n\ninterface VisitorMap {\n  [key: string]: (path: NodePath) => void\n}\n\nexport default class WebpackConformancePlugin {\n  private tests: IWebpackConformanceTest[]\n  private errors: Array<IConformanceAnomaly>\n  private warnings: Array<IConformanceAnomaly>\n  private compiler?: Compiler\n\n  constructor(options: IWebpackConformancePluginOptions) {\n    this.tests = []\n    if (options.tests) {\n      this.tests.push(...options.tests)\n    }\n    this.errors = []\n    this.warnings = []\n  }\n\n  private gatherResults(results: Array<IConformanceTestResult>): void {\n    results.forEach((result) => {\n      if (result.result === IConformanceTestStatus.FAILED) {\n        result.errors && this.errors.push(...result.errors)\n        result.warnings && this.warnings.push(...result.warnings)\n      }\n    })\n  }\n\n  private buildStartedHandler = (\n    compilation: compilation.Compilation,\n    callback: () => void\n  ) => {\n    const buildStartedResults: IConformanceTestResult[] = this.tests.map(\n      (test) => {\n        if (test.buildStared && this.compiler) {\n          return test.buildStared(this.compiler.options)\n        }\n        return {\n          result: IConformanceTestStatus.SUCCESS,\n        } as IConformanceTestResult\n      }\n    )\n\n    this.gatherResults(buildStartedResults)\n    callback()\n  }\n\n  private buildCompletedHandler = (\n    compilation: compilation.Compilation,\n    cb: () => void\n  ): void => {\n    const buildCompletedResults: IConformanceTestResult[] = this.tests.map(\n      (test) => {\n        if (test.buildCompleted) {\n          return test.buildCompleted(compilation.assets)\n        }\n        return {\n          result: IConformanceTestStatus.SUCCESS,\n        } as IConformanceTestResult\n      }\n    )\n\n    this.gatherResults(buildCompletedResults)\n    compilation.errors.push(...this.errors)\n    compilation.warnings.push(...this.warnings)\n    cb()\n  }\n\n  private parserHandler = (factory: compilation.NormalModuleFactory): void => {\n    const JS_TYPES = ['auto', 'esm', 'dynamic']\n    const collectedVisitors: Map<string, [NodeInspector?]> = new Map()\n    // Collect all interested visitors from all tests.\n    this.tests.forEach((test) => {\n      if (test.getAstNode) {\n        const getAstNodeCallbacks: IGetAstNodeResult[] = test.getAstNode()\n        getAstNodeCallbacks.forEach((result) => {\n          if (!collectedVisitors.has(result.visitor)) {\n            collectedVisitors.set(result.visitor, [])\n          }\n          ;(collectedVisitors.get(result.visitor) as NodeInspector[]).push(\n            result.inspectNode\n          )\n        })\n      }\n    })\n\n    // Do an extra walk per module and add interested visitors to the walk.\n    for (const type of JS_TYPES) {\n      factory.hooks.parser\n        .for('javascript/' + type)\n        .tap(this.constructor.name, (parser) => {\n          parser.hooks.program.tap(this.constructor.name, (ast: any) => {\n            const visitors: VisitorMap = {}\n            const that = this\n            for (const visitorKey of collectedVisitors.keys()) {\n              visitors[visitorKey] = function (path: NodePath) {\n                const callbacks = collectedVisitors.get(visitorKey) || []\n                callbacks.forEach((cb) => {\n                  if (!cb) {\n                    return\n                  }\n                  const { request } = parser.state.module\n                  const outcome = cb(path, { request })\n                  that.gatherResults([outcome])\n                })\n                this.traverse(path)\n                return false\n              }\n            }\n            visit(ast, visitors)\n          })\n        })\n    }\n  }\n\n  public apply(compiler: Compiler) {\n    this.compiler = compiler\n    compiler.hooks.make.tapAsync(\n      this.constructor.name,\n      this.buildStartedHandler\n    )\n    compiler.hooks.emit.tapAsync(\n      this.constructor.name,\n      this.buildCompletedHandler\n    )\n    compiler.hooks.normalModuleFactory.tap(\n      this.constructor.name,\n      this.parserHandler\n    )\n  }\n}\n"]}