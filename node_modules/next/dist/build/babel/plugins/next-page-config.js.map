{"version":3,"sources":["../../../../build/babel/plugins/next-page-config.ts"],"names":["STRING_LITERAL_DROP_BUNDLE","replaceBundle","path","t","parentPath","replaceWith","program","variableDeclaration","variableDeclarator","identifier","assignmentExpression","stringLiteral","Date","now","errorMessage","state","details","pageName","filename","split","cwd","pop","nextPageConfig","types","visitor","Program","enter","traverse","ExportNamedDeclaration","bundleDropped","node","declaration","BabelTypes","isVariableDeclaration","declarations","config","isIdentifier","id","name","isObjectExpression","init","got","type","Error","prop","properties","isSpreadElement","key","isObjectProperty","isBooleanLiteral","value","isStringLiteral","amp","file","opts","caller","isDev"],"mappings":"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","sourcesContent":["import { NodePath, PluginObj, types as BabelTypes } from '@babel/core'\nimport { PageConfig } from 'next/types'\n\nconst STRING_LITERAL_DROP_BUNDLE = '__NEXT_DROP_CLIENT_FILE__'\n\n// replace program path with just a variable with the drop identifier\nfunction replaceBundle(path: any, t: typeof BabelTypes): void {\n  path.parentPath.replaceWith(\n    t.program(\n      [\n        t.variableDeclaration('const', [\n          t.variableDeclarator(\n            t.identifier('config'),\n            t.assignmentExpression(\n              '=',\n              t.identifier(STRING_LITERAL_DROP_BUNDLE),\n              t.stringLiteral(`${STRING_LITERAL_DROP_BUNDLE} ${Date.now()}`)\n            )\n          ),\n        ]),\n      ],\n      []\n    )\n  )\n}\n\nfunction errorMessage(state: any, details: string): string {\n  const pageName =\n    (state.filename || '').split(state.cwd || '').pop() || 'unknown'\n  return `Invalid page config export found. ${details} in file ${pageName}. See: https://err.sh/vercel/next.js/invalid-page-config`\n}\n\ninterface ConfigState {\n  bundleDropped?: boolean\n}\n\n// config to parsing pageConfig for client bundles\nexport default function nextPageConfig({\n  types: t,\n}: {\n  types: typeof BabelTypes\n}): PluginObj {\n  return {\n    visitor: {\n      Program: {\n        enter(path, state: ConfigState) {\n          path.traverse(\n            {\n              ExportNamedDeclaration(\n                path: NodePath<BabelTypes.ExportNamedDeclaration>,\n                state: any\n              ) {\n                if (state.bundleDropped || !path.node.declaration) {\n                  return\n                }\n\n                if (!BabelTypes.isVariableDeclaration(path.node.declaration)) {\n                  return\n                }\n\n                const { declarations } = path.node.declaration\n                const config: PageConfig = {}\n\n                for (const declaration of declarations) {\n                  if (\n                    !BabelTypes.isIdentifier(declaration.id, { name: 'config' })\n                  ) {\n                    continue\n                  }\n\n                  if (!BabelTypes.isObjectExpression(declaration.init)) {\n                    const got = declaration.init\n                      ? declaration.init.type\n                      : 'undefined'\n                    throw new Error(\n                      errorMessage(state, `Expected object but got ${got}`)\n                    )\n                  }\n\n                  for (const prop of declaration.init.properties) {\n                    if (BabelTypes.isSpreadElement(prop)) {\n                      throw new Error(\n                        errorMessage(state, `Property spread is not allowed`)\n                      )\n                    }\n                    const { name } = prop.key\n                    if (BabelTypes.isIdentifier(prop.key, { name: 'amp' })) {\n                      if (!BabelTypes.isObjectProperty(prop)) {\n                        throw new Error(\n                          errorMessage(state, `Invalid property \"${name}\"`)\n                        )\n                      }\n                      if (\n                        !BabelTypes.isBooleanLiteral(prop.value) &&\n                        !BabelTypes.isStringLiteral(prop.value)\n                      ) {\n                        throw new Error(\n                          errorMessage(state, `Invalid value for \"${name}\"`)\n                        )\n                      }\n                      config.amp = prop.value.value as PageConfig['amp']\n                    }\n                  }\n                }\n\n                if (config.amp === true) {\n                  if (!state.file?.opts?.caller.isDev) {\n                    // don't replace bundle in development so HMR can track\n                    // dependencies and trigger reload when they are changed\n                    replaceBundle(path, t)\n                  }\n                  state.bundleDropped = true\n                  return\n                }\n              },\n            },\n            state\n          )\n        },\n      },\n    },\n  }\n}\n"]}